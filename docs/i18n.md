# i18n（国際化）ガイド

このドキュメントは、Web アプリにおける i18n の設定、関連ファイル、サーバ/クライアントでの辞書利用方法を説明します。

## 概要

- URL はロケールプレフィックスを使用します（例: `/en/...` または `/ja/...`）。
- 辞書は `apps/frontend/dictionaries/` の JSON です。
- サーバコンポーネントが `getDictionary()` で辞書を読み、クライアントへ渡します。
- ロケール判定とリダイレクトは `apps/frontend/proxy.ts` の Edge middleware で行います。
- 解決されたロケールに基づき `apps/frontend/app/layout.tsx` で HTML の `lang` を設定します。

## 主要ファイルと責務

- `apps/frontend/lib/i18n.ts`
  - `SUPPORTED_LOCALES` / `DEFAULT_LOCALE` / `Locale` 型を定義します。

- `apps/frontend/lib/dictionaries.ts`
  - `getDictionary(locale)` はロケール辞書を読み込みます（server-only）。
  - `getLang(localeCookie)` はロケール文字列を正規化します（layout で使用）。

- `apps/frontend/dictionaries/en.json` と `apps/frontend/dictionaries/ja.json`
  - 翻訳文字列のソースです。

- `apps/frontend/proxy.ts`
  - ロケール判定/リダイレクトの Edge middleware 実装です。
  - `SUPPORTED_LOCALES`/`DEFAULT_LOCALE` と `locale` cookie で言語を決定します。

- `apps/frontend/app/layout.tsx`
  - `locale` cookie を読み、`<html lang=...>` を設定します。

- `apps/frontend/components/sample-switcher/locale-switcher.tsx`
  - クライアント側のロケール切替（URL を組み替え）を担当します。

- `apps/frontend/app/[lang]/*/page.tsx`
  - `params.lang` を受け取り `getDictionary` を呼び、`dict` をクライアントへ渡します。

## ロケール解決フロー（リクエストライフサイクル）

1. リクエストは `apps/frontend/proxy.ts` の Edge middleware で処理されます。
   - URL にロケールがない場合は `/<locale>/...` へリダイレクトします。
   - ロケールの優先順位は次の通りです。
     1. URL のロケールプレフィックス（存在すれば）
     2. `locale` cookie
     3. `Accept-Language` ヘッダー

2. 選ばれたロケールは `locale` cookie（path `/`）に保存されます。

3. Next.js の描画時に以下が行われます。
   - `apps/frontend/app/layout.tsx` が cookie を読み、`<html lang=...>` を設定
   - `apps/frontend/app/[lang]/.../page.tsx` が `getDictionary(lang)` で辞書を取得
   - 辞書をクライアントコンポーネントへ props で渡す

## コンポーネントでの辞書利用方法

### サーバコンポーネント（App Router page）

サーバコンポーネントは `params` からロケールを取得し、`getDictionary` で辞書を読み込みます。

```ts
import { getDictionary } from "@/lib/dictionaries";
import { type Locale } from "@/lib/i18n";
import { SampleClient } from "@/features/sample";

const SamplePage = async ({ params }: { params: Promise<{ lang: Locale }> }) => {
  const { lang } = await params;
  const dict = await getDictionary(lang);

  return <SampleClient dict={dict} />;
};

export default SamplePage;
```

サーバコンポーネントでも辞書を直接参照して表示できます（必ずしもクライアントへ渡すだけではありません）。`privacy` セクションを取り出して JSX で使う例です。

```ts
import { type Locale } from "@/lib/i18n";
import { getDictionary } from "@/lib/dictionaries";

type PrivacyPageProps = {
  params: Promise<{ lang: Locale }>;
};

const PrivacyPage = async ({ params }: PrivacyPageProps) => {
  const { lang } = await params;
  const dict = await getDictionary(lang);
  const { privacy } = dict;

  return (
    <main>
      <h1>{privacy.title}</h1>
      <p>
        {privacy.lastUpdatedLabel}: {privacy.lastUpdatedValue}
      </p>
    </main>
  );
};

export default PrivacyPage;
```

### クライアントコンポーネント（feature entry）

クライアントコンポーネントは `dict` を props として受け取り、辞書 JSON の型で定義します。実装ではセクション（例: `login`）を取り出して直接キーを使うケースが多いです。

```ts
"use client";

type Dictionary = typeof import("@/dictionaries/en.json");

type SampleClientProps = {
  dict: Dictionary;
};

export const SampleClient = ({ dict }: SampleClientProps) => {
  const { login } = dict;

  return <h1>{login.welcomeBack}</h1>;
};
```

## 新しいロケールの追加

1. 新しい辞書 JSON を追加します。
   - `apps/frontend/dictionaries/<new-locale>.json`

2. `apps/frontend/lib/i18n.ts` を更新します。
   - `SUPPORTED_LOCALES` にロケールを追加します。

3. `apps/frontend/lib/dictionaries.ts` を更新します。
   - `dictionaries` マップにローダーを追加します。

4. ロケール切替と middleware の挙動を確認します。
   - `apps/frontend/components/sample-switcher/locale-switcher.tsx`
   - `apps/frontend/proxy.ts`

## 注意点

- `apps/frontend/lib/dictionaries.ts` は `server-only` と動的 import を使用するため、クライアントから直接 `getDictionary` を呼びません。
- 辞書のスキーマはロケール間で一致させてください（キー構成を揃える）。
- キーを追加/変更する場合は全ロケールの JSON を同時に更新します。
- ルーティングは `/[lang]` に依存するため、内部リンクはロケールを保持します。
