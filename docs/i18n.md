# i18n (internationalization) guide

This document explains how i18n is configured in the web app, which files are involved, and how to use dictionaries in server and client components.

このドキュメントは、Web アプリにおける i18n の設定、関連ファイル、サーバ/クライアントでの辞書利用方法を説明します。

## Overview

- URL structure uses a locale prefix: `/en/...` or `/ja/...`.
- URL はロケールプレフィックスを使用します（例: `/en/...` または `/ja/...`）。

- Dictionaries are JSON files in `apps/web/dictionaries/`.
- 辞書は `apps/web/dictionaries/` の JSON です。

- Server components load dictionaries via `getDictionary()` and pass them to client components.
- サーバコンポーネントが `getDictionary()` で辞書を読み、クライアントへ渡します。

- Locale detection and redirects live in the Edge middleware logic in `apps/web/proxy.ts`.
- ロケール判定とリダイレクトは `apps/web/proxy.ts` の Edge middleware で行います。

- The HTML `lang` attribute is set in `apps/web/app/layout.tsx` based on the resolved locale.
- 解決されたロケールに基づき `apps/web/app/layout.tsx` で HTML の `lang` を設定します。

## Key files and responsibilities

- `apps/web/lib/i18n.ts`
  - Defines `SUPPORTED_LOCALES`, `DEFAULT_LOCALE`, and the `Locale` type.
  - `SUPPORTED_LOCALES` / `DEFAULT_LOCALE` / `Locale` 型を定義します。

- `apps/web/lib/dictionaries.ts`
  - `getDictionary(locale)` loads the JSON dictionary for a locale (server-only).
  - `getDictionary(locale)` はロケール辞書を読み込みます（server-only）。

  - `getLang(localeCookie)` normalizes a locale string (used by layout).
  - `getLang(localeCookie)` はロケール文字列を正規化します（layout で使用）。

- `apps/web/dictionaries/en.json` and `apps/web/dictionaries/ja.json`
  - Source of translation strings.
  - 翻訳文字列のソースです。

- `apps/web/proxy.ts`
  - Edge middleware logic for locale detection and redirect.
  - ロケール判定/リダイレクトの Edge middleware 実装です。

  - Uses `SUPPORTED_LOCALES`/`DEFAULT_LOCALE` and a `locale` cookie to decide language.
  - `SUPPORTED_LOCALES`/`DEFAULT_LOCALE` と `locale` cookie で言語を決定します。

- `apps/web/app/layout.tsx`
  - Reads the locale cookie and sets `<html lang=...>`.
  - `locale` cookie を読み、`<html lang=...>` を設定します。

- `apps/web/components/sample-switcher/locale-switcher.tsx`
  - Client-side locale switcher that rebuilds the path with a new locale prefix.
  - クライアント側のロケール切替（URL を組み替え）を担当します。

- `apps/web/app/[lang]/*/page.tsx`
  - Server components that receive `params.lang`, call `getDictionary`, and pass `dict` to client features.
  - `params.lang` を受け取り `getDictionary` を呼び、`dict` をクライアントへ渡します。

## Locale resolution flow (request lifecycle)

1) Incoming request hits the Edge middleware logic in `apps/web/proxy.ts`.
   リクエストは `apps/web/proxy.ts` の Edge middleware で処理されます。

   - If the URL does not start with a supported locale, it redirects to `/<locale>/...`.
   - URL にロケールがない場合は `/<locale>/...` へリダイレクトします。

   - Locale is chosen in this order:
     1. URL locale prefix (if present)
     2. `locale` cookie
     3. `Accept-Language` header

   - ロケールの優先順位は次の通りです。
     1. URL のロケールプレフィックス（存在すれば）
     2. `locale` cookie
     3. `Accept-Language` ヘッダー

2) The selected locale is stored in the `locale` cookie (path `/`).
   選ばれたロケールは `locale` cookie（path `/`）に保存されます。

3) The Next.js app renders:
   Next.js の描画時に以下が行われます。

   - `apps/web/app/layout.tsx` reads the cookie and sets the `<html lang=...>` attribute.
   - `apps/web/app/layout.tsx` が cookie を読み、`<html lang=...>` を設定

   - `apps/web/app/[lang]/.../page.tsx` loads the dictionary via `getDictionary(lang)`.
   - `apps/web/app/[lang]/.../page.tsx` が `getDictionary(lang)` で辞書を取得

   - The dictionary is passed into the client component as a prop.
   - 辞書をクライアントコンポーネントへ props で渡す

## How to use dictionaries in components

### Server component (App Router page)

Server components should read the locale from `params` and load the dictionary via `getDictionary`.
サーバコンポーネントは `params` からロケールを取得し、`getDictionary` で辞書を読み込みます。

```ts
import { getDictionary } from "@/lib/dictionaries";
import { type Locale } from "@/lib/i18n";
import { SampleClient } from "@/features/sample";

const SamplePage = async ({ params }: { params: Promise<{ lang: Locale }> }) => {
  const { lang } = await params;
  const dict = await getDictionary(lang);

  return <SampleClient dict={dict} />;
};

export default SamplePage;
```

Server components can also consume the dictionary directly (not only pass it down). A common pattern is to destructure a section and use its keys in JSX, like the privacy page.
サーバコンポーネントでも辞書を直接参照して表示できます（必ずしもクライアントへ渡すだけではありません）。`privacy` セクションを取り出して JSX で使う例です。

```ts
import { type Locale } from "@/lib/i18n";
import { getDictionary } from "@/lib/dictionaries";

type PrivacyPageProps = {
  params: Promise<{ lang: Locale }>;
};

const PrivacyPage = async ({ params }: PrivacyPageProps) => {
  const { lang } = await params;
  const dict = await getDictionary(lang);
  const { privacy } = dict;

  return (
    <main>
      <h1>{privacy.title}</h1>
      <p>
        {privacy.lastUpdatedLabel}: {privacy.lastUpdatedValue}
      </p>
    </main>
  );
};

export default PrivacyPage;
```

### Client component (feature entry)

Client components should accept a `dict` prop and type it using the dictionary JSON. In practice, many components destructure a section (e.g. `login`) and use its keys directly.
クライアントコンポーネントは `dict` を props として受け取り、辞書 JSON の型で定義します。実装ではセクション（例: `login`）を取り出して直接キーを使うケースが多いです。

```ts
"use client";

type Dictionary = typeof import("@/dictionaries/en.json");

type SampleClientProps = {
  dict: Dictionary;
};

export const SampleClient = ({ dict }: SampleClientProps) => {
  const { login } = dict;

  return <h1>{login.welcomeBack}</h1>;
};
```

## Adding a new locale

1) Add a new dictionary JSON file:
   - `apps/web/dictionaries/<new-locale>.json`
   - 新しい辞書 JSON を追加します。

2) Update `apps/web/lib/i18n.ts`:
   - Add the new locale to `SUPPORTED_LOCALES`.
   - `SUPPORTED_LOCALES` にロケールを追加します。

3) Update `apps/web/lib/dictionaries.ts`:
   - Add a new loader in the `dictionaries` map.
   - `dictionaries` マップにローダーを追加します。

4) Confirm the locale switcher and middleware behavior:
   ロケール切替と middleware の挙動を確認します。
   - `apps/web/components/sample-switcher/locale-switcher.tsx`
   - `apps/web/proxy.ts`

## Notes and dependencies to be careful about

- `apps/web/lib/dictionaries.ts` uses `server-only` and dynamic imports; do not call `getDictionary` directly in client components.
- `apps/web/lib/dictionaries.ts` は `server-only` と動的 import を使用するため、クライアントから直接 `getDictionary` を呼びません。

- Keep the dictionary schema consistent across locales (matching keys).
- 辞書のスキーマはロケール間で一致させてください（キー構成を揃える）。

- If you add or rename keys, update all locale JSON files together.
- キーを追加/変更する場合は全ロケールの JSON を同時に更新します。

- Locale routing relies on the `/[lang]` segment; internal links should preserve the locale prefix.
- ルーティングは `/[lang]` に依存するため、内部リンクはロケールを保持します。
